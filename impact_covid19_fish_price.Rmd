---
title: "COVID19の漁業に対する影響"
author: "Keita Abe"
date: "`r Sys.Date()`"
output:
  minidown::mini_document:
    framework: water
    theme: light
    toc: true
    toc_float: true
    code_folding:
      source: hide
      output: show
      message: hide
      warning: hide
      error: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(tidyverse,
               lubridate,
               viridis,
               readxl,
               scales,
               ggridges)

fig_size <- function(width, heigth){
     options(repr.plot.width = width, repr.plot.height = heigth)
}

dat2 = read_csv("monthly_landing_market_aggregate_201001_202004.csv")
# data is downloaded and compiled in "draft_data_dl.R"

```

# データ

まず産地市場における影響を調査するため、[水産物流通調査](http://www.market.jafic.or.jp/index.html)から産地水産物のデータを取得した。データは月毎の主要漁港における主要魚種の水揚げ量と平均価格を含んでいる。

輸出入に対する影響を調査するために貿易統計を、漁業者の反応を見るためにGFWを使う予定。


# 産地市場における影響

## 日本全体

### 価格への影響

```{r plot_price}
# plot price change  

ggplot(dat2 %>% filter(year == 2020),
       aes(x = price_kg_rel_year_mon*100, y = species, col = factor(month))) + 
  geom_point() + 
  geom_vline(xintercept = 100, col = "red", alpha= 0.7) +
  xlim(0,200) + 
  scale_color_viridis(discrete=TRUE) +
  labs(x = "単価の前年同月比 (%)", y="魚種項目", col = "月(2020年)") + 
  theme(legend.position = "bottom",
        text = element_text(family = "HiraKakuPro-W3"))  

ggplot(dat2 %>% filter(year == 2019 & month <= 4),
       aes(x = price_kg_rel_year_mon*100, y = species, col = factor(month))) + 
  geom_point() + 
  geom_vline(xintercept = 100, col = "red", alpha = 0.7) +
  xlim(0,200) + 
  scale_color_viridis(discrete=TRUE) +
  labs(x = "単価の前年同月比 (%)", y="魚種項目", col = "月(2019年)") + 
  theme(legend.position = "bottom",
        text = element_text(family = "HiraKakuPro-W3"),
        plot.background = element_blank())  

# distribution
ggplot(dat2 %>% filter(month <= 4),
       aes(x = price_kg_rel_year_mon*100, group = year ,color = (year == 2020))) +
  geom_density(alpha = 0.7,position = "identity") + 
  xlim(0,200) + 
  scale_color_discrete(label = c("2019年以前","2020年")) + 
  labs(x = "単価の前年同月比 (%)",y = "密度",color = "年", title = "各年の前年同月比分布",
       subtitle = "単価：1月から４月") + 
  theme(legend.position = "bottom",
        text = element_text(family = "HiraKakuPro-W3"),
        plot.background = element_blank())  


# distribution
ggplot(dat2 %>% filter(month <= 4),
       aes(x = price_kg_rel_year_mon*100, group = year ,color = (year == 2020))) +
  geom_density(alpha = 0.7,position = "identity") + 
  xlim(0,200) + 
  scale_color_discrete(label = c("2019年以前","2020年")) + 
  labs(x = "単価の前年同月比 (%)",y = "密度",color = "年", title = "各年の前年同月比分布",
       subtitle = "単価：1月から４月") + 
  theme(legend.position = "bottom",
        text = element_text(family = "HiraKakuPro-W3"),
        plot.background = element_blank())  +
  facet_wrap(~month)

```

### 水揚げ量への影響

```{r plot_land}
# landing

ggplot(dat2 %>% filter(year == 2020),
       aes(x = landing_t_rel_year_mon*100, y = species, col = factor(month))) + 
  geom_point() + 
  geom_vline(xintercept = 100, col = "red", alpha= 0.7) +
  scale_color_viridis(discrete=TRUE) +
  labs(x = "水揚げ量の前年同月比 (%)", y="魚種項目", col = "月(2020年)") + 
  xlim(0,200) + 
  theme(legend.position = "bottom",
        text = element_text(family = "HiraKakuPro-W3")) 

  
ggplot(dat2 %>% filter(year == 2019 & month <= 4),
       aes(x = landing_t_rel_year_mon*100, y = species, col = factor(month))) + 
  geom_point() + 
  geom_vline(xintercept = 100, col = "red", alpha= 0.7) +
  labs(x = "水揚げ量の前年同月比 (%)", y="魚種項目", col = "月(2019年)") + 
  scale_color_viridis(discrete=TRUE) +
  xlim(0,200) + 
  theme(legend.position = "bottom",
        text = element_text(family = "HiraKakuPro-W3"))  

# distribution
ggplot(dat2 %>% filter(month <= 4),
       aes(x = landing_t_rel_year_mon*100, group = year ,color = (year == 2020))) +
  geom_density(alpha = 0.7,position = "identity") + 
  xlim(0,200) + 
  scale_color_discrete(label = c("2019年以前","2020年")) + 
  labs(x = "水揚げ量の前年同月比 (%)",y = "密度",color = "年", title = "各年の前年同月比分布",
       subtitle = "水揚げ量: 1月から４月") + 
  theme(legend.position = "bottom",
        text = element_text(family = "HiraKakuPro-W3"),
        plot.background = element_blank()) 


# distribution by month
ggplot(dat2 %>% filter(month <= 4),
       aes(x = landing_t_rel_year_mon*100, group = year ,color = (year == 2020))) +
  geom_density(alpha = 0.7,position = "identity") + 
  xlim(0,200) + 
  scale_color_discrete(label = c("2019年以前","2020年")) + 
  labs(x = "水揚げ量の前年同月比 (%)",y = "密度",color = "年", title = "各年の前年同月比分布",
       subtitle = "水揚げ量: 1月から４月") + 
  theme(legend.position = "bottom",
        text = element_text(family = "HiraKakuPro-W3"),
        plot.background = element_blank()) + 
  facet_wrap(~month)
```

## 漁港市場別

```{r dat_port2}
dat_port2 = read_csv("monthly_landing_market_by_port_201001_202004.csv") %>%
  # ratio relative to previous month
  arrange(port,species,date) %>%
  group_by(port,species) %>%
  mutate(across(c(landing_t,price_kg), ~.x/lag(.x,1), .names = "{col}_rel_prev_mon")) %>%
  ungroup() %>%
  # ratio relative to same month previous year
  arrange(port,species,month,year) %>%
  group_by(port,species,month) %>%
  mutate(across(c(landing_t,price_kg), ~.x/lag(.x,1), .names = "{col}_rel_year_mon")) %>%
  ungroup() %>%
  arrange(port,species,date) %>%
  # if NaN or infinity, convert to zero. 
  mutate(across(starts_with("landing_t") | starts_with("price_kg"),~ifelse(is.nan(.x) | is.infinite(.x), NA, .x))) %>%
  # year dummy
  mutate(yr20 = ifelse(year == 2020,1,0),
         rev = landing_t*price_kg) # 1000 JPY
```


### 価格への影響

####　漁港別 

特に北日本で大きな影響があるか？

```{r, fig.width=6, fig.height=10,}

ggplot(dat_port2 %>% filter(month %in% c(1:4)), aes(x = price_kg_rel_year_mon*100, y = reorder(port, -port_code), fill = factor(yr20))) +
  geom_density_ridges(alpha = 0.5) + 
  xlim(0,200) + 
  scale_fill_viridis_d(label = c("2019 and before","2020")) +
  labs(title = "単価の前年同月比", subtitle= "漁港別",
       x = "単価の前年同月比 (%)", y = "主要漁港", fill = "年") +
  theme_bw() +
  theme(text = element_text(family = "HiraKakuPro-W3"))

```

####　魚種別

```{r, fig.width=6, fig.height=10,}

ggplot(dat_port2 %>% filter(month %in% c(1:4)), aes(x = price_kg_rel_year_mon*100, y = species, fill = factor(yr20))) +
  geom_density_ridges(alpha = 0.5) + 
  xlim(0,200) + 
  scale_fill_viridis_d(label = c("2019 and before","2020")) +
  labs(title = "単価の前年同月比", subtitle= "魚種別",
       x = "単価の前年同月比 (%)", y = "魚種", fill = "年") +
  theme_bw() +
  theme(text = element_text(family = "HiraKakuPro-W3"))

```

### 水揚げ量への影響

####　漁港別 

データポイントが年-魚種。

```{r, fig.width=6, fig.height=10,}

ggplot(dat_port2 %>% filter(month %in% c(1:4)), aes(x = landing_t_rel_year_mon*100, y = reorder(port,-port_code), fill = factor(yr20))) +
  geom_density_ridges(alpha = 0.5) + 
  xlim(0,200) + 
  scale_fill_viridis_d(label = c("2019 and before","2020")) +
  labs(title = "水揚げ量の前年同月比", subtitle= "漁港別",
       x = "水揚げ量の前年同月比 (%)", y = "主要漁港", fill = "年") +
  theme_bw() +
  theme(text = element_text(family = "HiraKakuPro-W3"))

```

####　魚種別

データポイントが年-漁港。

```{r, fig.width=6, fig.height=10,}

ggplot(dat_port2 %>% filter(month %in% c(1:4)), aes(x = landing_t_rel_year_mon*100, y = species, fill = factor(yr20))) +
  geom_density_ridges(alpha = 0.5) + 
  xlim(0,200) + 
  scale_fill_viridis_d(label = c("2019 and before","2020")) +
  labs(title = "水揚げ量の前年同月比", subtitle= "魚種別",
       x = "水揚げ量の前年同月比 (%)", y = "魚種", fill = "年") +
  theme_bw() +
  theme(text = element_text(family = "HiraKakuPro-W3"))

```

### 水揚げ高への影響

#### 月毎の水揚げ高の年比較

```{r}
dat_port3 = dat_port2 %>%
  group_by(port,year,month) %>%
  summarise(landing_t_tot = sum(landing_t,na.rm =TRUE),
            price_kg_mean = mean(price_kg, na.rm = TRUE),
            price_kg_sd = sd(price_kg,na.rm = TRUE),
            rev_1000JPY = sum(landing_t*price_kg,na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(yr20 = ifelse(year == 2020, 1, 0))
```


```{r, fig.width=8, fig.height=12}

ggplot(dat_port3 %>% filter(month %in% c(1:4)), 
       aes(x = log10(rev_1000JPY), y = port, col = factor(yr20))) +
  geom_point(alpha = 0.7, size = 3) + 
  # xlim(0,200) + 
  scale_color_discrete(limits = c(1,0),label = c("2020","2019 and before")) + scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  labs(title = "漁港別水揚げ高", subtitle= "1-4月",
       x = "漁獲高(千円)", y = "主要漁港", col = "年") +
  theme_bw() +
  theme(text = element_text(family = "HiraKakuPro-W3")) + 
  facet_wrap(~month)

```

# 貿易統計


```{r}
df_tr = read_csv("trade_stats_fish_gaikyohin_1988_2019_monthly.csv")

df_tr_agg = df_tr %>%
  mutate(value_MT = ifelse(unit == "KG",value/1000,value)) %>%
  group_by(year,month,ix,cat01_code,product,type) %>%
  summarise(across(value_MT, list(sum = ~sum(.x,na.rm = TRUE)))) %>%
  ungroup() %>%
  pivot_wider(names_from = type, values_from = value_MT_sum) %>%
  mutate(unit_value = `金額`/`数量`) %>%
  mutate(year2020 = ifelse(year == 2020, 1, 0))

```

## 魚介類

調整品を除いた魚介類の輸出入の月別推移。

輸出については、2020年に入ってから金額は横ばいになっているが、
実際には輸出量が増加している一方で単価は下がり続けている。
->　仮説：輸出先が変わっている？輸出物が代替している？

輸入は、金額・量ともに低く、量は過去一番で低い値で推移。
単価は最高ではないが、過去と比較して高い。⇢供給が減っているから高くなっているか？


```{r}
# total value
ggplot(df_tr_agg %>% filter(cat01_code == "00701000") %>%
         mutate(`value_sum_金額` = ifelse(`金額` == 0,NA,`金額`)),
       aes(x = factor(month), y = `value_sum_金額`, col = factor(year2020), group = year)) + 
  geom_line() + 
  labs(x = "Month", y = "Total value (1000 JPY)", col = "Year") + 
  scale_color_discrete(labels = c("1988-2019","2020")) + 
  facet_wrap(~ix) 

# total quantity
ggplot(df_tr_agg %>% filter(cat01_code == "00701000") %>%
         mutate(`数量` = ifelse(`数量` == 0,NA,`数量`)),
       aes(x = factor(month), y = `数量`, col = factor(year2020), group = year)) + 
  geom_line() + 
  labs(x = "Month", y = "Total quantity (MT)", col = "Year") + 
  scale_color_discrete(labels = c("1988-2019","2020")) + 
  facet_wrap(~ix) 

# unit value
ggplot(df_tr_agg %>% filter(cat01_code == "00701000"),
       aes(x = factor(month), y = unit_value, col = factor(year2020), group = year)) + 
  geom_line() +
  labs(x = "Month", y = "Unit value (JPY/kg)", col = "Year") +
  scale_color_discrete(labels = c("1988-2019","2020")) + 
  facet_wrap(~ix)
```

## By products

輸出物は、4月にかけて単価が下がっているものが多いが、はっきりしない。
輸入物は、価格が高めになっている傾向。

フォーカスすべき魚種を整理して統計品(より詳細)のデータを引っ張ってくるべきか？

### total value

```{r, fig.height=10,fig.width=5}


ggplot(df_tr_agg %>% filter(month %in% c(1,2,3,4)) %>%
         filter(product != "うなぎの稚魚"), 
       aes(x =log10(`金額`), y =product, col = factor(year2020))) + 
  geom_point() +
  scale_color_discrete(labels = c("1988-2019","2020")) + 
  theme(text = element_text(family = "HiraKakuPro-W3"),
        legend.position = "bottom") + scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) + 
  labs(x = "金額 (1000JPY, 対数)", col = "Year", y = "Product") +
  facet_grid(month ~ ix)
  
```

### unit value 
"うなぎの稚魚"は単価が高すぎるため、比較から除外

```{r, fig.height=10,fig.width=5}


ggplot(df_tr_agg %>% filter(month %in% c(1,2,3,4)) %>%
         filter(product != "うなぎの稚魚"), 
       aes(x = unit_value, y =product, col = factor(year2020))) + 
  geom_point() +
  scale_color_discrete(labels = c("1988-2019","2020")) + 
  theme(text = element_text(family = "HiraKakuPro-W3"),
        legend.position = "bottom") + 
  labs(x = "Unit value (JPY/kg)", col = "Year", y = "Product") +
  facet_grid(month ~ ix)
  

```


# 研究課題

- 具体的にどこでどの程度、どんな魚種が影響を受けたか？
- 何が原因と考えられるか？国内需要の変化？輸出ショック？　
- 輸入ショックによる価格増加はあるか？
- 漁獲の多様性とCOVIDショックに対する頑健性に相関はあるか？

## 使えそうなデータ

- 貿易統計(輸出入)
- 外食需要
- デパートの売り上げ（高級魚の需要がありそう
- スーパーの売り上げ（商業動態統計で取れそう）
